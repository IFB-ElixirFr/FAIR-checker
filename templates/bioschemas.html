<link rel="stylesheet" href="../static/css/bulma-divider.min.css">{% extends "layout.html" %}

{% block nav %}
{% include 'nav.html' %}
{% endblock %}

{% block body %}

<!-- TESTING Display -->
<script>
    function filterNodesById(nodes, id) {
        return nodes.filter(function (n) { return n.id === id; });
    }

    function triplesToGraph(triples) {

        svg.html("");
        //Graph
        var graph = { nodes: [], links: [] };

        //Initial Graph from triples
        triples.forEach(function (triple) {
            var subjId = triple.subject;
            var predId = triple.predicate;
            var objId = triple.object;

            var subjNode = filterNodesById(graph.nodes, subjId)[0];
            var objNode = filterNodesById(graph.nodes, objId)[0];

            if (subjNode == null) {
                subjNode = { id: subjId, label: subjId, weight: 1 };
                graph.nodes.push(subjNode);
            }

            if (objNode == null) {
                objNode = { id: objId, label: objId, weight: 1 };
                graph.nodes.push(objNode);
            }


            graph.links.push({ source: subjNode, target: objNode, predicate: predId, weight: 1 });
        });

        return graph;
    }

    function addNewTriples(triples_list) {

        graph = triplesToGraph(triples_list);
        update();
    }

    function update() {
        // ==================== Add Marker ====================
        svg.append("svg:defs").selectAll("marker")
            .data(["end"])
            .enter().append("svg:marker")
            .attr("id", String)
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 30)
            .attr("refY", -0.5)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto")
            .append("svg:polyline")
            .attr("points", "0,-5 10,0 0,5")
            ;

        // ==================== Add Links ====================
        var links = svg.selectAll(".link")
            .data(graph.links)
            .enter()
            .append("line")
            .attr("marker-end", "url(#end)")
            .attr("class", "link")
            .attr("stroke-width", 1)
            ;//links

        // ==================== Add Link Names =====================
        var linkTexts = svg.selectAll(".link-text")
            .data(graph.links)
            .enter()
            .append("text")
            .attr("class", "link-text")
            .text(function (d) { return d.predicate; })
            ;

        //linkTexts.append("title")
        //		.text(function(d) { return d.predicate; });

        // ==================== Add Link Names =====================
        var nodeTexts = svg.selectAll(".node-text")
            .data(graph.nodes)
            .enter()
            .append("text")
            .attr("class", "node-text")
            .text(function (d) { return d.label; })
            ;

        //nodeTexts.append("title")
        //		.text(function(d) { return d.label; });

        // ==================== Add Node =====================
        var nodes = svg.selectAll(".node")
            .data(graph.nodes)
            .enter()
            .append("circle")
            .attr("class", "node")
            .attr("r", 8)
            .call(force.drag)
            ;//nodes

        // ==================== Force ====================
        force.on("tick", function () {
            nodes
                .attr("cx", function (d) { return d.x; })
                .attr("cy", function (d) { return d.y; })
                ;

            links
                .attr("x1", function (d) { return d.source.x; })
                .attr("y1", function (d) { return d.source.y; })
                .attr("x2", function (d) { return d.target.x; })
                .attr("y2", function (d) { return d.target.y; })
                ;

            nodeTexts
                .attr("x", function (d) { return d.x + 12; })
                .attr("y", function (d) { return d.y + 3; })
                ;


            linkTexts
                .attr("x", function (d) { return 4 + (d.source.x + d.target.x) / 2; })
                .attr("y", function (d) { return 4 + (d.source.y + d.target.y) / 2; })
                ;
        });

        // ==================== Run ====================
        force
            .nodes(graph.nodes)
            .links(graph.links)
            .charge(-500)
            .linkDistance(100)
            .start()
            ;
    }



</script>

<script type="text/javascript" charset="utf-8">

    $(document).ready(function () {

        console.log("ready!");
        $("#notif").addClass("is-hidden");

        console.log('trying to connect...');
        var socket = io.connect({{ config['SERVER_IP']| tojson }});
    //var socket = io();
    console.log('connected');

    //////////////////
    // click handlers
    //////////////////

    {% for f in f_metrics %}
    $("#test_{{f.id}}").click(function () {
        console.log("Testing metric {{f.name}}");
        console.log("ID: " + "{{f.id}}");
        console.log("Value: " + "{{f.api_url}}");
        $(this).addClass("is-loading");

        socket.emit('retrieve_embedded_annot', {
            url: $("#url").val()
        });
    });
    {% endfor %}

    // Exemple selector List
    {% for k in sample_data.keys() %}
    $("#sample_{{k}}").on("change", function () {
        console.log(this.value);
        $("#url").val(this.value);
        $('#sample_{{k}} option[value="{{ k }}"]').attr("selected", "selected");
    });
    {% endfor %}

    // Exemple selector Button
    $('[id^="resource_"]').on("click", function () {
        console.log($(this).children("a").text());
        $("#url").val($(this).children("a").data("url"));
    });


    $("#btn_kg").click(function () {
        $(this).addClass("is-loading");
        $("#microdata").val("");
        $("#nb_triples").text("0" + " triples");
        $('#block_valid').html("");
        $('#t_classes').html("");
        $('#t_properties').html("");
        socket.emit('retrieve_embedded_annot_2', { url: $("#url").val() });
    });

    $("#btn_describe_biotools").click(function () {
        $(this).addClass("is-loading");
        graph = $("#microdata").val();
        url = $("#url").val();
        socket.emit('describe_biotools', { url: url, graph: graph });
    });

    $("#btn_describe_loa").click(function () {
        $(this).addClass("is-loading");
        graph = $("#microdata").val();
        url = $("#url").val();
        socket.emit('describe_loa', { url: url, graph: graph });
    });

    $("#btn_describe_wikidata").click(function () {
        $(this).addClass("is-loading");
        graph = $("#microdata").val();
        url = $("#url").val();
        socket.emit('describe_wikidata', { url: url, graph: graph });
    });

    $("#btn_describe_opencitation").click(function () {
        $(this).addClass("is-loading");
        graph = $("#microdata").val();
        url = $("#url").val();
        socket.emit('describe_opencitation', { url: url, graph: graph });
    });

    $("#btn_annot_bioschemas").click(function () {
        $("#article-BioSchemas-annot").removeClass("is-hidden");
    });

    $("#btn_fairness").click(function () {
        $(this).addClass("is-loading");
        $("#section-KG").removeClass("is-hidden");
        $("#section-LinkedData").removeClass("is-hidden");
        $("#section-BioSchemas").addClass("is-hidden");
        socket.emit('check_kg', { url: $("#url").val() });
    });

    $("#btn_bioschemas").click(function () {
        $(this).addClass("is-loading");
        $("#section-KG").removeClass("is-hidden");
        // $("#section-LinkedData").addClass("is-hidden");
        // $("#section-BioSchemas").removeClass("is-hidden");
        socket.emit('check_kg_shape_2', { url: $("#url").val(), kg: $("#microdata").val() });
    });

    // Change RDF type button

    $('[id^="btn_rdf_"]').click(function () {
        var rdf_type = $(this).data("rdf");
        console.log("change RDF syntax to " + rdf_type);
        socket.emit('change_rdf_type', { rdf_type: rdf_type });
    });

    // TABS for Step 3

    $("#bioschemas_tab").click(function () {
        $(this).addClass("is-active");
        $("#linkeddata_tab").removeClass("is-active");

        $("#section-LinkedData").addClass("is-hidden");
        $("#section-BioSchemas").removeClass("is-hidden");
    });

    $("#linkeddata_tab").click(function () {
        $(this).addClass("is-active");
        $("#bioschemas_tab").removeClass("is-active");

        $("#section-LinkedData").removeClass("is-hidden");
        $("#section-BioSchemas").addClass("is-hidden");
    });


    $("#btn_submit_annot_bioschemas").click(function () {

        var err_selector = $('[id^="bs_err_annot_"]');
        var warn_selector = $('[id^="bs_warn_annot_"]');
        var url = $('#url').val();

        var err = {};
        err_selector.each(function () {
            val = $(this).val();
            property = $(this).parent("div").parent().children("label").children("a").text();
            err[property] = val;
        });

        var warn = {};
        warn_selector.each(function () {
            val = $(this).val();
            property = $(this).parent("div").parent().children("label").children("a").text();
            warn[property] = val;
        });
        console.log(warn);
        socket.emit('update_annot_bioschemas', { err: err, warn: warn, url: url });
    });

    //////////////////
    // event handlers
    //////////////////

    socket.on('connect', function () {
        socket.emit('hello', { data: 'I\'m connected!' });
        console.log('hello message sent');
    });

    socket.on('update_annot_2', function (value) {
        console.log("UPDATE ANNOT 2")
        if ("done".includes(value)) {
            $("#p1").attr("value", 4);
        } else {
            console.log('received ' + value + ' for p1');
            $("#p1").attr("value", value);
        }
    });
    socket.on('send_annot_2', function (value) {
        console.log(value);
        $("#section-describe").find(".block").removeClass("is-hidden");
        $("#article-bioschemas-check").find(".block").removeClass("is-hidden");
        $("#microdata").val(value["kg"]);
        $("#nb_triples").text(value["nb_triples"] + " triples");
        $("#btn_describe_opencitation").removeClass("is-loading");
        $("#btn_describe_wikidata").removeClass("is-loading");
        $("#btn_describe_biotools").removeClass("is-loading");
        $("#btn_describe_loa").removeClass("is-loading");
        $("#btn_kg").removeClass("is-loading");
    });

    socket.on('send_bs_annot', function (value) {
        $("#annotated_bioschemas").val(value);
    });


    socket.on('test', function (value) {
        console.log(value)
    });

    socket.on('done_check_shape', function (data) {
        console.log("Validated SHACL shape");
        console.log(data);
        var valid_html = "";
        $.each(data, function (key, value) {
            var resource = key
            var type = data[key]['type']
            var profile = data[key]['ref_profile']
            var conforms = data[key]['conforms']
            valid_html += '<div class="block">'
            valid_html += '<h5 class="subtitle"> <span class="tag is-info is-light"><a target=_blank href=' + resource + '></h5'
            valid_html += '<p>' + resource + '</a></span> has type <span class="tag is-dark"><a target=_blank href=' + type + '>' + type + '</a></span> </p>'
            valid_html += '<p>should be conform to profile <span class="tag is-dark"><a target=_blank href=' + profile + '>' + profile + '</a></span></p><br>'

            if (conforms == true) {
                valid_html += '<p> has a <span class="has-text-success has-text-weight-bold">valid</span> Bioschemas profile</p>'
            } else {
                valid_html += '<div class="columns is-multiline is-mobile">'
                valid_html += '<div class="column is-one-half">'
                valid_html += '<table class="table is-striped is-fullwidth">'
                valid_html += '<thead><tr><th>Required missing properties</th></tr></thead>'
                valid_html += '<tbody>'
                $.each(data[key]['errors'], function (index, item) {
                    var row = '<tr>';
                    row += '<td> <span class="tag is-light"><a target=_blank href=' + item + '>' + item + '</a></span> <span class="has-text-danger has-text-weight-bold">must be</span> provided</td>';
                    valid_html += row + '</tr>';
                });
                valid_html += '</tbody></table></div>'
                valid_html += '<div class="column is-one-half">'
                valid_html += '<table class="table is-striped is-fullwidth">'
                valid_html += '<thead><tr><th>Improvements</th></tr></thead>'
                valid_html += '<tbody>'
                $.each(data[key]['warnings'], function (index, item) {
                    var row = '<tr>';
                    row += '<td><span class="tag is-light"><a target=_blank href=' + item + '>' + item + '</a></span> <span class="has-text-warning has-text-weight-bold">should be</span> provided</td>';
                    valid_html += row + '</tr>';
                });
                valid_html += '</tbody></table></div>'
                valid_html += '</div>'
            }
            valid_html += '</div>'
        });
        $('#block_valid').html(valid_html);
        $("#btn_bioschemas").removeClass("is-loading");
        $("#btn_annot_bioschemas").removeClass("is-hidden");
    });



    {% for f in f_metrics %}
    socket.on('done_{{f.id}}', function (value) {
        console.log('DONE {{f.name}}');
        $("#test_{{f.id}}").removeClass("is-loading");

        console.log(value['score']);
        if (value['score'] == 1) {
            $("#status_{{f.id}}").addClass("is-success");
        } else {
            $("#status_{{f.id}}").addClass("is-danger");
        }
        console.log(value['comment']);

    });
    {% endfor %}


    socket.on('long', function (value) {
        console.log('END LONG');
        $("#notif").text(value);
        $("#notif").removeClass("is-hidden");
    });


    data = {{ results | tojson | safe }};
    console.log(data)
    var valid_html = "";
    $.each(data, function (key, value) {
        var resource = key
        var type = data[key]['type']
        var profile = data[key]['ref_profile']
        var conforms = data[key]['conforms']
        valid_html += '<div class="block">'
        valid_html += '<h5 class="subtitle"> <span class="tag is-info is-light"><a target=_blank href=' + resource + '></h5'
        valid_html += '<p>' + resource + '</a></span> has type <span class="tag is-dark"><a target=_blank href=' + type + '>' + type + '</a></span> </p>'
        valid_html += '<p>should be conform to profile <span class="tag is-dark"><a target=_blank href=' + profile + '>' + profile + '</a></span></p><br>'

        if (conforms == true) {
            valid_html += '<p> has a <span class="has-text-success has-text-weight-bold">valid</span> Bioschemas profile</p>'
        } else {
            valid_html += '<div class="columns is-multiline is-mobile">'
            valid_html += '<div class="column is-one-half">'
            valid_html += '<table class="table is-striped is-fullwidth">'
            valid_html += '<thead><tr><th>Required missing properties</th></tr></thead>'
            valid_html += '<tbody>'
            $.each(data[key]['errors'], function (index, item) {
                var row = '<tr>';
                row += '<td> <span class="tag is-light"><a target=_blank href=' + item + '>' + item + '</a></span> <span class="has-text-danger has-text-weight-bold">must be</span> provided</td>';
                valid_html += row + '</tr>';
            });
            valid_html += '</tbody></table></div>'
            valid_html += '<div class="column is-one-half">'
            valid_html += '<table class="table is-striped is-fullwidth">'
            valid_html += '<thead><tr><th>Improvements</th></tr></thead>'
            valid_html += '<tbody>'
            $.each(data[key]['warnings'], function (index, item) {
                var row = '<tr>';
                row += '<td><span class="tag is-light"><a target=_blank href=' + item + '>' + item + '</a></span> <span class="has-text-warning has-text-weight-bold">should be</span> provided</td>';
                valid_html += row + '</tr>';
            });
            valid_html += '</tbody></table></div>'
            valid_html += '</div>'
        }
        valid_html += '</div>'
    });
    console.log(valid_html)
    $('#block_valid').html(valid_html);
    $("#section-describe").find(".block").removeClass("is-hidden");
    $("#article-bioschemas-check").find(".block").removeClass("is-hidden");
    $("#btn_annot_bioschemas").removeClass("is-hidden");

});



</script>

<div class="block">
    Validating the resource metadata against Bioschemas community profiles.
</div>

<article class="message">
    <div class="message-body is-inspect">
        <h2 class="subtitle"><b>Fetch RDF metadata from the resource URL</b></h2>
        {% for k in sample_data.keys() %}
        <div class="field is-grouped">
            <p class="is-small">{{k}}:&nbsp;</p>
            {% for s in sample_data[k] %}
            <p id="resource_{{k}}_{{loop.index}}" class="control"><a class="button is-small is-text"
                    data-url="{{ s.url }}">{{ s.text
                    }}</a></p>
            {% endfor %}
        </div>
        {% endfor %}
        <div class="field has-addons">
            <div class="control is-expanded">

                <div class="control has-icons-left has-icons-right">
                    <input id="url" name="url" class="input" type="text" placeholder="FAIR resource URL">
                    <span class="icon is-small is-left">
                        <i class="fa fa-link"></i>
                    </span>
                </div>
            </div>
            <div class="field is-grouped is-grouped-centered">
                <p class="control">
                    <a id="btn_kg" class="button is-info">Build Knowledge Graph</a>
                </p>
            </div>
        </div>
    </div>
</article>


<article class="message">
    <div id="article-bioschemas-check">
        <div class="message-body is-inspect">
            <h1 class="subtitle"><b>Bioschemas validation results</b></h1>
            <div class="block is-hidden">

                <section id="section-BioSchemas" class="section  is-hidden">

                    <!-- <h3 class="title is-3">BioSchemas profiles checks</h3> -->
                    <p>Bioschemas is a community effort aimed at reusing and extending Schema.org for better life
                        science digital resource findability. Several profiles are defined for each kind of Life Science
                        resources, specifying minimal, recommended or optional information. Are minimal
                        information missing ? Should other information be provided for better findability ?</p>
                    <br>
                    <div class="field is-grouped is-grouped-centered">
                        <!-- <p class="control"><a id="btn_fairness" class="button is-primary">Vocab. checks</a></p> -->
                        <p class="control"><a id="btn_bioschemas" class="button is-warning is-large">Check BioSchemas
                            </a>
                        </p>
                    </div>

                    <div id="block_valid" class="block">

                    </div>

                </section>

            </div>
        </div>
    </div>
</article>
<!--    </div>-->
<!-- </section> -->
<div class="block">
    <article id="article-BioSchemas-annot" class="message is-info is-hidden">
        <div class="message-header">
            <p>Step 4: Annotate missing properties</p>
        </div>
        <div class="message-body">
            <section id="section-Annot" class="section">
                <div class="columns is-multiline is-mobile">
                    <div class="column is-one-half">
                        <table class="table is-striped is-fullwidth">
                            <thead>
                                <tr>
                                    <th>Required missing properties</th>
                                </tr>
                            </thead>
                            <tbody id="t_errors_annot">
                            </tbody>
                        </table>
                    </div>
                    <div class="column is-one-half">
                        <table class="table is-striped is-fullwidth">
                            <thead>
                                <tr>
                                    <th>Improvements</th>
                                </tr>
                            </thead>
                            <tbody id="t_warnings_annot">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="field is-grouped is-grouped-centered">
                    <p class="control"><a id="btn_submit_annot_bioschemas" class="button is-warning">Annotate Bioschemas
                            profile</a></p>
                </div>
                <div class="control">
                    <textarea id="annotated_bioschemas" class="textarea is-small"
                        placeholder="BioSchemas annotation will be shown here" rows="15"></textarea>
                </div>
            </section>
        </div>
    </article>
</div>

{% endblock %}