{% extends "layout.html" %}

{% block nav %}
{% include 'nav.html' %}
{% endblock %}

{% block body %}

<script type="text/javascript" charset="utf-8">
  $(document).ready(function () {

    var socket = io.connect({{ config['SERVER_IP']| tojson }});

    // socket.emit('connect', { data: 'Connecting!' });
    
  //////////////////
  // select url to test
  //////////////////
  {% for k in sample_data.keys() %}
  $("#sample_{{k}}").on("click", function () {
    $("#url").val(this.value);
    $("#url").trigger('input');
    $('#sample_{{k}} option[value="{{ k }}"]').attr("selected", "selected");
  });
  {% endfor %}

  // Exemple selector Button
  $('[id^="resource_"]').on("click", function () {
    $("#url").val($(this).children("a").data("url"));
    $("#url").trigger("input");
  });


  //////////////////
  // click handlers
  //////////////////

  {% for f in f_metrics %}
  $("#test_{{f.id}}").on('click', function ($e) {
    $e.preventDefault();

    $(this).addClass("is-loading");

    $("#row_score_{{f.id}}").text("");
    $("#modal_score_{{f.id}}").text("");
    $("#row_time_{{f.id}}").text("");
    $("#modal_time_{{f.id}}").text("");
    $("#row_comment_{{f.id}}").parent("div").find('button').hide();
    $("#modal_comment_{{f.id}}").text("");
    $("#row_status_{{f.id}}").removeClass("is-danger is-success");
    $("#row_status_{{f.id}}").text("Status");
    $("#test_row_guideline_{{f.id}}").text("");
    $("#modal_guideline_{{f.id}}").text("");
    $("#show_more_reco_{{f.id}}").hide();
    $("#metrics_row_{{ f.id }}").css('background-color', '');
    $("#metrics_row_{{ f.id }}").hover(function(){
      $(this).css("background-color", "");
    }, function(){
      $(this).css("background-color", "");
    });

    if( !$("#btn_test_all").hasClass("is-loading") ){
      $("#btn_test_all").addClass("is-loading");
    }
    if( !$("#download_csv").hasClass("is-loading") ){
      $("#download_csv").prop("disabled", true);
    }

    let url;
    if ($("#doi_button").val() === $("#url").val()) {
      url = "https://doi.org/" + $("#url").val();
    } else {
      url = $("#url").val();
    }

    // socket.emit('evaluate_{{f.id}}', {
    socket.emit('evaluate_metric', {
      metric_name: "{{ f.name }}",
      url: url,
      api_url: "{{f.api_url}}",
      id: "{{f.id}}",
      principle: "{{f.principle}}",
      implem: "{{f.implem}}",
      uuid: $("#download_csv").data("dl"),
    });
  });
  {% endfor %}


  //////////////////
  // event handlers
  //////////////////

  var csv_lines = []

  {% for f in f_metrics %}
  // modal listner
  $('[id^=modal_details_{{ f.id }}]').on('click', function ($e) {
    target_id = $(this).data("target");
    $("#" + target_id).addClass("is-active");
    // $("#" + target_id).addClass("is-clipped");
  });
  // close with BG
  $('[id^=modal_bg_{{ f.id }}]').on('click', function ($e) {
    $('[id^=modal_{{ f.id }}]').removeClass("is-active");
  });
  // close with close button
  $('[id^=modal_close_{{ f.id }}]').on('click', function ($e) {
    $('[id^=modal_{{ f.id }}]').removeClass("is-active");
  });

  // metrics tests results handling
  socket.on('error_{{f.id}}', function (value) {
    $("#test_{{f.id}}").removeClass("is-loading");
    $("#row_status_{{f.id}}").text("Error");
    $("#row_status_{{f.id}}").addClass("is-warning");
    $("#metrics_row_{{ f.id }}").css('background-color', '#FFF7DF');
    $("#row_score_{{f.id}}").text("NA");
    // show comment buttpn
    $("#row_comment_{{f.id}}").parent("div").find('button').show();
    // add comment to result
    $("#row_comment_{{f.id}}").children("article").removeClass("is-info");
    $("#row_comment_{{f.id}}").children("article").children("div").text("Error with FAIR-Checker or FAIRMetrics API, don't hesitate to contact the support with the URL that give an error, thank you.");

    // check if all metric are done
    is_loading = false
    $('[id^=test_metric_]').each(function (id) {
      if ($(this).hasClass("is-loading")) {
        is_loading = true;
      }
    });
    if (!is_loading) {
      $("#btn_test_all").removeClass("is-loading");
    }

    // put checkbox in tested state true and trigger change
    $("#checkbox_test_{{f.id}}").data('tested', true).trigger("change");
  });

  socket.on('done_{{f.id}}', function (value) {

    $("#test_{{f.id}}").removeClass("is-loading");

    csv_lines.push(value['csv_line']);




    // change status color
    if (value['score'] >= 1) {
      $("#row_status_{{f.id}}").removeClass("is-danger");
      $("#row_status_{{f.id}}").addClass("is-success");
      $("#row_status_{{f.id}}").text("Success");
      $("#result_{{f.id}}").addClass("is-success");
      // update_checkbox color
      $("#checkbox_test_{{f.id}}").parent("label").parent("td").css('background-color', '#DBF2F2');
      $("#metrics_row_{{ f.id }}").css('background-color', '#dbf2f2');
      $("#metrics_row_{{ f.id }}").hover(function(){
        $(this).css("background-color", "#c7ebeb");
      }, function(){
        $(this).css("background-color", "#dbf2f2");
      });
    } else {
      $("#row_status_{{f.id}}").removeClass("is-success");
      $("#row_status_{{f.id}}").addClass("is-danger");
      $("#row_status_{{f.id}}").text("Failure");
      $("#result_{{f.id}}").addClass("is-danger");
      // update_checkbox color
      $("#checkbox_test_{{f.id}}").parent("label").parent("td").css('background-color', '#FFE0E6');
      $("#metrics_row_{{ f.id }}").css('background-color', '#ffe6eb');
      $("#metrics_row_{{ f.id }}").hover(function(){
        $(this).css("background-color", "#ffccd6");
      }, function(){
        $(this).css("background-color", "#ffe6eb");
      });
    }

    // add score to result
    $("#row_score_{{f.id}}").text(value['score']);
    $("#modal_score_{{f.id}}").text(value['score']);
    // add time to result
    $("#row_time_{{f.id}}").text(value['time']);
    $("#modal_time_{{f.id}}").text(value['time']);
    // show comment buttpn
    $("#row_comment_{{f.id}}").parent("div").find('button').show();
    // add comment to result
    $("#row_comment_{{f.id}}").children("article").removeClass("is-info");
    $("#row_comment_{{f.id}}").children("article").children("div").html(value['comment']);
    $("#modal_comment_{{f.id}}").html(value['comment']);


    //update progressbar
    progress = 0
    $("#p1").attr("value", progress);
    $('[id^=row_score]').each(function (progress) {
      if ($(this).text() != "") {
        $("#p1").attr("value", progress + 1);
      }
    });

    $("#p1").parent().closest('div').data("label", "toto");

    // add recommandation if score == 0
    if (value['recommendation'] != "No recommendation, metric validated") {
      {#$("#row_guideline_{{f.id}}").parent("div").find('button').show()#}
      $("#show_more_reco_{{f.id}}").show();
      $("#row_guideline_{{f.id}}").children("article").children("div").html(value['recommendation']);
      $("#modal_guideline_{{f.id}}").html(value['recommendation']);
      $("#test_row_guideline_{{f.id}}").html(value['recommendation']);
    } else {
      $("#row_guideline_{{f.id}}").parent("div").find('button').hide();
      $("#show_more_reco_{{f.id}}").hide();
    }

    $("#show_more_reco_{{f.id}} a").off();
    $("#show_more_reco_{{f.id}} a").on("click", function() {
        var $this = $(this);
        var $content = $this.parent().prev("div.content");
        var linkText = $this.children('span');
        var $img = $this.children('i');
        var showing = $this.data("show");
        if(showing === "no"){
            $content.addClass("show-content", 500);
            $content.removeClass("hide-content", 500);
            $img.addClass("fa-caret-up");
            $img.removeClass("fa-caret-down");
            $this.children('span').html('Read less');
            $this.data("show", "yes");
        } else {
            $content.addClass("hide-content", 500);
            $content.removeClass("show-content", 500);
            $img.addClass("fa-caret-down");
            $img.removeClass("fa-caret-up");
            $this.children('span').html('Read more');
            $this.data("show", "no");
        };

    });

    // // show table
    $("#result_table_{{f.id}}").show();

    // check if all metric are done
    is_loading = false
    $('[id^=test_]').each(function (id) {
      if ($(this).hasClass("is-loading")) {
        is_loading = true;
      }
    });
    if (!is_loading) {
      $("#btn_test_all").removeClass("is-loading");
      $("#download_csv").prop("disabled", false);
    }

    // put checkbox in tested state true and trigger change
    $("#checkbox_test_{{f.id}}").data('tested', true).trigger("change");

    update_radar_chart2();

  });
  {% endfor %}

  //////////////////
  // exec all button
  //////////////////

  // start all metrics test
  $("#btn_test_all").on('click', function ($e) {
    if ($(url).val() === "") {
      alert("Please, enter a resource identifier !");
      return false;
    }
    $("#btn_test_checked").prop('disabled', true);
    $("#btn_test_all").addClass("is-loading");
    $('[id^=test_]').each(function (id) {
      $(this).trigger("click");
    });
  });


  //  detect doi regex
  $("#url").on('input', function (id) {

    str_url = $(this).val();
    result = test_DOI(str_url);

    if (result) {
      var doi_button = $('<button>', {
        "id": "doi_button",
        "class": "button is-small is-info is-light",
        "title": "Click to select only the DOI",
        "value": result,
      })
        .text(result)
        // .append('<i class="fa fa-clipboard is-pulled-left"></i>')
        .click(function () {
          $("#url").val(result);
        });
      doi_button.prepend('<i class="fa fa-clipboard is-pulled-left"></i>&ensp;');

      $("#is_doi").html('&ensp;-&ensp;The input contains the following DOIs that you can also test: ');
      $("#is_doi").append(doi_button);

    } else {
      $("#is_doi").text("");
    };
  });


  $("#url").on('input', function (id) {
    str_url = $(this).val();
    helper = $("#url_helper");
    statut_logo = $("#url_statut");
    if (is_valid_http_url(str_url) || test_DOI(str_url)) {
      socket.emit('webresource', str_url)

      $(this).removeClass("is-danger");
      $(this).addClass("is-success");
      helper.removeClass("is-danger");
      helper.addClass("is-success");
      helper.text("The URL/DOI is valid");
      statut_logo.addClass("fa-check");
      statut_logo.removeClass("fa-exclamation-triangle");
    } else if (str_url === "") {
      $(this).removeClass("is-danger");
      $(this).removeClass("is-success");
      helper.removeClass("is-danger");
      helper.removeClass("is-success");
      helper.text("");
      statut_logo.removeClass("fa-check");
      statut_logo.removeClass("fa-exclamation-triangle");
    } else {
      console.log("Is not valid !");
      $(this).removeClass("is-success");
      $(this).addClass("is-danger");
      helper.removeClass("is-success");
      helper.addClass("is-danger");
      helper.text("The URL/DOI is not valid");
      statut_logo.removeClass("fa-check");
      statut_logo.addClass("fa-exclamation-triangle");
    };
  });

  // Generate file to export checks results in CSV
  $("#download_csv").on('click', function ($e) {
    csv_lines.sort(function (a, b) {
        return a.id.substring(3) - b.id.substring(3);
    });

    let csv_export = Array();
    for (const csv_line of csv_lines) {
        let array_csv_line = Array();
        for ( const [key, value] of Object.entries(csv_line)) {
            let value_clean = value;
            if (key === "comment") {
                value_clean = value.replaceAll("<br>", "\n");
                if (value_clean.slice(-1) === "\n") {
                    value_clean = value_clean.slice(0, -1);
                }
            }

            array_csv_line.push('"' + value_clean + '"');
        }
        csv_export.push(array_csv_line.join(","));
    }

    let uri = "data:text/csv;charset=utf-8," + encodeURIComponent(csv_export.join("\n"));
    let downloadLink = document.createElement("a");
    downloadLink.href = uri;
    downloadLink.download = "fc_results.csv";
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
  });


  });

  function test_DOI(str_url) {
    doi_regex = /10.\d{4,9}\/[-._;()\/:A-Z0-9]+/gmi;
    return str_url.match(doi_regex);
  }

  function is_valid_http_url(string) {
    let url;

    try {
      url = new URL(string);
    } catch (_) {
      return false;
    }

    return url.protocol === "http:" || url.protocol === "https:";
  }


</script>

<!-- input uri section -->
<article id="url_selection" class="message">

  <div class="message-body is-check">
    <h1 class="subtitle"><b>Enter resource identifier (URL/DOI)</b></h1>
    <div class="field has-addons">
      <div class="control is-expanded">

        <div class="control has-icons-left has-icons-right">
          <input id="url" name="url" class="input is-large" type="text" placeholder="FAIR resource URL or DOI">
          <span class="icon is-small is-left">
            <i class="fa fa-link"></i>
          </span>
          <span class="icon is-small is-right">
            <i id="url_statut" class="fa"></i>
          </span>
        </div>
        <div class="help_wrapper"><span id="url_helper" class="help"></span><span class="help" id="is_doi"></span></div>
      </div>
      <div class="field is-grouped is-grouped-centered">
        <p class="control">
          <button id="btn_test_all" class="button is-info is-large"><i class="fa fa-bar-chart fa-fw"></i>&nbsp;Test all
            metrics
          </button>
        </p>
      </div>
    </div>

    <br>

    <!-- progress bar -->
    <div class="columns is-centered is-vcentered">
      <div class="column is-half">
        <progress id="p1" class="progress is-primary is-centered" value="0" max="11"></progress>

      </div>
      <div class="column is-narrow">
        <p class="control">
          <button onClick="window.location.reload();" class="button is-primary is-small"><i
              class="fa fa-undo fa-fw"></i>&nbsp;Clean
            results
          </button>
        </p>
      </div>
    </div>

    <!-- resource examples -->
    {% for k in sample_data.keys() %}
    <div class="columns is-centered">
      <div class="column is-narrow">
        <div class="panel">
          <div class="panel-block is-centered is-vcentered">
            <div class="field is-grouped ">
              {% for s in sample_data[k] %}
              <p id="resource_{{k}}_{{loop.index}}" class="control"><a class="button is-small is-text"
                  data-url="{{ s.url }}">{{ s.text }}</a></p>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}

  </div>

</article>


<!-- Metrics selection checkboxes section [NOT USED] -->
<article id="select_metrics" class="message" style="display: none;">
  <div class="message-header">
    <p>Select the metrics you want to test</p>
  </div>
  <div class="message-body">
    <div class="columns is-centered">
      {% for category in ['F', 'A', 'I', 'R'] %}
      <div class="is-one-quarter">
        <table id="metrics_checkboxes" class="table is-hoverable is-bordered is-striped">
          <thead>
            <th>
              <label class="checkbox">
                <input id="checkbox_all_{{ category }}" data-target="checkbox_{{ category }}" type="checkbox">
                {{ category }} - All

              </label>
            </th>
          </thead>
          <!-- Remove hidden to show tables -->
          <tbody>
            <!-- <tbody hidden> -->
            {% for f in f_metrics %}
            {% if f.principle_category == category %}
            <tr>
              <td>
                <label class="checkbox">
                  <input name="checkbox_{{ category }}" id="checkbox_test_{{ f.id }}" data-target="test_{{ f.id }}"
                    data-tested=false type="checkbox">
                  {{ f.principle_tag }} - {{ f.name }}

                </label>
              </td>
            </tr>
            {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endfor %}
    </div>
    <br>

  </div>
</article>


<!-- Radar chart summary -->
<article id="radar_chart" class="message">
  <div class="message-body is-check">
    <h1 class="subtitle"><b>Radar chart of metrics completion</b></h1>
    <div class="content">{% include 'radar_chart.html' %}</div>
  </div>
</article>

<!-- Metrics table -->
<article id="metrics_details_rec" class="message">
  <div class="message-body is-check">
    <h1 class="subtitle is-inline-block"><b>List of metrics with details and results</b></h1>

    <button id="download_csv" data-dl="{{ uuid }}" download="results.csv" class="button is-info is-small is-pulled-right" disabled><i class="fa fa-download fa-fw"></i>&nbsp;Export</button>

    <div class="content">{% include 'metrics_table.html' %}</div>
    <br>
    <div class="content">
      For additional tips and recommandations on how to improve your resource, we recommand you to use the FAIR
      Cookbook:
      <a href="https://fairplus.github.io/the-fair-cookbook/content/home.html" target="_blank"
        rel="noopener noreferrer">https://fairplus.github.io/the-fair-cookbook/content/home.html</a>
    </div>
  </div>


</article>

{% include 'metrics_modal.html' %}

</div>

<script type="text/javascript">
  document.addEventListener('DOMContentLoaded', function () {
    let cardToggles = document.getElementsByClassName('card-toggle');
    for (let i = 0; i < cardToggles.length; i++) {
      cardToggles[i].addEventListener('click', e => {
        e.currentTarget.parentElement.parentElement.childNodes[3].classList.toggle('is-hidden');
      });
    }
  });

</script>

{% endblock %}