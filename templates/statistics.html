{% extends "layout.html" %}

{% block nav %}
{% include 'nav.html' %}
{% endblock %}

{% block body %}

<script type="text/javascript" charset="utf-8">

    $( document ).ready(function() {

<!--        var cm = new CodeMirror.fromTextArea(document.getElementById("editor"), {-->
<!--            lineNumbers: true,-->
<!--            lineWrapping: true,-->
<!--         });-->

        console.log( "ready!" );
        $("#notif").addClass("is-hidden");

        console.log('trying to connect...');
        var socket = io.connect({{ config['SERVER_IP']|tojson }});
        //var socket = io();
        console.log('connected');

        //////////////////
        // click handlers
        //////////////////



        //////////////////
        // event handlers
        //////////////////

        socket.on('connect', function() {
            socket.emit('hello', {data: 'I\'m connected!'});
            console.log('hello message sent');
        });
    });
</script>

<section class="hero is-warning">
  <div class="hero-body">
    <div class="container">
<!--      <h1 class="title">-->
<!--        Primary title-->
<!--      </h1>-->
<!--      <h2 class="subtitle">-->
<!--        Primary subtitle-->
<!--      </h2>-->

      <section class="section">
          <nav class="level">
            <div class="level-item has-text-centered">
              <div>
                <p class="heading">Evaluations this week</p>
                <p class="title">{{ evals }}</p>
              </div>
            </div>
            <div class="level-item has-text-centered">
              <div>
                <p class="heading">Success this week</p>
                <p class="title">{{ success }}</p>
              </div>
            </div>
            <div class="level-item has-text-centered">
              <div>
                <p class="heading">Failures this week</p>
                <p class="title">{{ failures }}</p>
              </div>
            </div>
          </nav>
        </section>

      <section class="section">
          <nav class="level">
            <div class="level-item has-text-centered">
              <div>
                <p class="heading">FINDABLE this week</p>
                <p class="title">{{ f_success }}</p>
              </div>
            </div>
            <div class="level-item has-text-centered">
              <div>
                <p class="heading">not FINDABLE this week</p>
                <p class="title">{{ f_failures }}</p>
              </div>
            </div>
          </nav>
        </section>

        <section class="section">
          <nav class="level">
            <div class="level-item has-text-centered">
              <div>
                <p class="heading">ACCESSIBLE this week</p>
                <p class="title">{{ a_success }}</p>
              </div>
            </div>
            <div class="level-item has-text-centered">
              <div>
                <p class="heading">not ACCESSIBLE this week</p>
                <p class="title">{{ a_failures }}</p>
              </div>
            </div>
          </nav>
        </section>

      <section class="section">
          <nav class="level">
            <div class="level-item has-text-centered">
              <div>
                <p class="heading">INTEROPERABLE this week</p>
                <p class="title">{{ i_success }}</p>
              </div>
            </div>
            <div class="level-item has-text-centered">
              <div>
                <p class="heading">not INTEROPERABLE this week</p>
                <p class="title">{{ i_failures }}</p>
              </div>
            </div>
          </nav>
        </section>

      <section class="section">
          <nav class="level">
            <div class="level-item has-text-centered">
              <div>
                <p class="heading">REUSABLE this week</p>
                <p class="title">{{ r_success }}</p>
              </div>
            </div>
            <div class="level-item has-text-centered">
              <div>
                <p class="heading">not REUSABLE this week</p>
                <p class="title">{{ r_failures }}</p>
              </div>
            </div>
          </nav>
        </section>


    </div>
  </div>
</section>


<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>

<!-- //////////////////
/// First BAR Chart ///
/////////////////// -->

<section>
  <!-- Create a div where the graph will take place -->
  <div id="my_dataviz" class="columns is-mobile is-centered"></div>

</section>

<script>

// set the dimensions and margins of the graph
var margin = {top: 10, right: 30, bottom: 20, left: 50},
    width = 460 - margin.left - margin.right,
    height = 400 - margin.top - margin.bottom;

// append the svg object to the body of the page
var svg = d3.select("#my_dataviz")
  .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

// Parse the Data
d3.csv("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/data_stacked.csv", function(data) {

  var data2 = [
    {"metric": "Total", "success": {{ success }}, "failure": {{ failures }}},
    {"metric": "F", "success": {{ f_success }}, "failure": {{ f_failures }}},
    {"metric": "A", "success": {{ a_success }}, "failure": {{ a_failures }}},
    {"metric": "I", "success": {{ i_success }}, "failure": {{ i_failures }}},
    {"metric": "R", "success": {{ r_success }}, "failure": {{ r_failures }}},
  ]
  data2["columns"] = ["metric", "success", "failure"]
  data = data2
  // List of subgroups = header of the csv files = soil condition here
  var subgroups = data.columns.slice(1)
  console.log(subgroups);

  // List of groups = species here = value of the first column called group -> I show them on the X axis
  var groups = d3.map(data, function(d){return(d.metric)}).keys()
  console.log(groups);

  // Add X axis
  var x = d3.scaleBand()
      .domain(groups)
      .range([0, width])
      .padding([0.2])
  svg.append("g")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x).tickSize(0));

  // Add Y axis
  // Calcul height
  max_height = Math.max({{ success }}, {{ failures }}) + 5;
  var y = d3.scaleLinear()
    .domain([0, max_height])
    .range([ height, 0 ]);
  svg.append("g")
    .call(d3.axisLeft(y));

  // Another scale for subgroup position?
  var xSubgroup = d3.scaleBand()
    .domain(subgroups)
    .range([0, x.bandwidth()])
    .padding([0.05])

  // color palette = one color per subgroup
  var color = d3.scaleOrdinal()
    .domain(subgroups)
    .range(['#4daf4a', '#e41a1c'])

  // Show the bars
  svg.append("g")
    .selectAll("g")
    // Enter in data = loop group per group
    .data(data)
    .enter()
    .append("g")
      .attr("transform", function(d) { return "translate(" + x(d.metric) + ",0)"; })
    .selectAll("rect")
    .data(function(d) { return subgroups.map(function(key) { return {key: key, value: d[key]}; }); })
    .enter().append("rect")
      .attr("x", function(d) { return xSubgroup(d.key); })
      .attr("y", function(d) { return y(d.value); })
      .attr("width", xSubgroup.bandwidth())
      .attr("height", function(d) { return height - y(d.value); })
      .attr("fill", function(d) { return color(d.key); });

})

</script>


<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
<!-- //////////////////
/// Second BAR Chart ///
/////////////////// -->

<!-- <canvas id="myChart" width="400" height="400"></canvas> -->
<section>
  <!-- Create a div where the graph will take place -->
  <div>
    <canvas id="myChart" class="columns is-mobile is-centered"></canvas>
  </div>
</section>


<script>
  var ctx = document.getElementById("myChart").getContext("2d");



  var data2 = {
      labels: ["Total", "F", "A", "I", "R"],
      datasets: [
          {
              label: "Success",
              backgroundColor: "green",
              data: [{{ success }},{{ f_success }},{{ a_success }},{{ i_success }},{{ r_success }}]
          },
          {
              label: "Failures",
              backgroundColor: "red",
              data: [{{ failures }},{{ f_failures }},{{ a_failures }},{{ i_failures }},{{ r_failures }}]
          }
      ]
  };



  var myBarChart = new Chart(ctx, {
      type: 'bar',
      data: data2,
      options: {
          barValueSpacing: 20,
          scales: {
              yAxes: [{
                  ticks: {
                      min: 0,
                  }
              }]
          }
      }
  });
</script>



<section>

  <div >
    <canvas id="myLineChart" class="columns is-mobile is-centered" ></canvas>
  </div>

</section>
<script>
  var ctx = document.getElementById("myLineChart").getContext("2d");
  console.log( {{ success_weekly|tojson }});

  const labels = Object.keys({{ success_weekly|tojson }});
  const values_success = Object.values({{ success_weekly|tojson }});
  const values_failures = Object.values({{ failures_weekly|tojson }});

  var data = {
      labels: labels,
      datasets: [
          {
              label: "Success",
              borderColor: "green",
              // backgroundColor: 'rgba(0, 0, 0, 0.1)',
              fill: false,
              data: values_success,
          },
          {
              label: "Failures",
              borderColor: "red",
              // backgroundColor: 'rgba(0, 0, 0, 0.1)',
              fill: false,
              data: values_failures,
          },
      ]
  };

  var myLineChart = new Chart(ctx, {
    type: 'line',
    data: data,

  });
</script>

{% endblock %}
